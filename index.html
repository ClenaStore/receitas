<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel â€¢ Setores e Receitas</title>
<style>
  :root{ --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f7f7f7; --muted:#cfcfcf; --brand:#2563eb; --ghost:#374151; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(#0f0f10,#0f0f10cc);backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--line)}
  .top{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px;max-width:1100px;margin:0 auto}
  .top h1{font-size:1.2rem;margin:0}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--ghost);background:#111;font-size:.8rem}

  .btn{border:1px solid var(--ghost);background:#121212;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand)}

  .container{max-width:1100px;margin:16px auto;padding:0 16px 24px}
  .grid{display:grid;gap:14px}
  @media (min-width: 840px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media (min-width: 1200px){ .grid{grid-template-columns:repeat(4,1fr)} }

  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
  .card.clickable{cursor:pointer;transition:transform .06s ease}
  .card.clickable:hover{transform:translateY(-2px)}
  .muted{color:var(--muted)}
  .caps{letter-spacing:.04em;text-transform:uppercase;font-size:.78rem;color:#a7a7a7}

  .list{display:grid;gap:12px}
  @media (min-width: 768px){ .list{grid-template-columns:repeat(2,1fr)} }
  .item-card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px;display:flex;gap:12px;align-items:flex-start}
  .thumb{flex:0 0 120px;height:90px;border-radius:10px;object-fit:cover;border:1px solid var(--line);background:#0d0d0e}
  .item-body{flex:1}
  .item-title{font-weight:700;margin-bottom:4px}
  .item-sub{font-size:.85rem;color:var(--muted)}
  .item-actions{display:flex;gap:8px;margin-top:8px}

  .detail{display:grid;gap:14px}
  @media (min-width: 900px){ .detail{grid-template-columns: 1.1fr 1fr} }
  .hero{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
  .hero img{width:100%;max-height:360px;object-fit:cover;border-radius:12px;border:1px solid var(--line);background:#0d0d0e}
  .hero h2{margin:10px 0 6px}
  .hero .meta{display:flex;gap:8px;flex-wrap:wrap}
  .box{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
  .ing-list{list-style:none;padding:0;margin:0;display:grid;gap:8px}
  .ing-list li{display:flex;justify-content:space-between;gap:10px;border-bottom:1px dashed #1e1e1f;padding-bottom:6px}
  .ing-left{display:flex;gap:8px;align-items:center}
  input{background:#0f0f10;border:1px solid var(--line);color:#fff;border-radius:10px;padding:10px}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;border:1px solid #333;color:#fff;padding:10px 14px;border-radius:10px;z-index:999;box-shadow:0 6px 24px rgba(0,0,0,.4);opacity:0;transition:opacity .2s}
</style>
</head>
<body>
<header>
  <div class="top">
    <h1 id="headerTitle">Setores</h1>
    <div class="actions" id="headerActions"><span class="pill" id="badgeTotal">Carregandoâ€¦</span></div>
  </div>
</header>

<div class="container" id="app"></div>
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* ===== CONFIG ===== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwQXKB5NtAEq5tZDYXKCexiWoeYAhA1Nn86a_pTodz_tbYiqu_meZJvth5vURuPt94r/exec';

const SETORES = {
  bar: ['DRINKS','CACHAÃ‡AS','COQUETÃ‰IS','BEBIDAS','SUCOS','CAIPIRINHAS'],
  confeitaria: ['CONFEITARIA','DOCES','BOLOS'],
  padaria: ['PADARIA','PÃƒES','SALGADOS'],
  cozinha: ['COZINHA','PRATOS','ALMOÃ‡O','JANTAR'],
};
const NOME_SETOR = { bar:'Bar', confeitaria:'Confeitaria', padaria:'Padaria', cozinha:'Cozinha' };

/* ===== ESTADO ===== */
let RECEITAS = [];
let INDEX_BY_ID = new Map();

/* ===== HELPERS ===== */
const $ = s=>document.querySelector(s);
const app = $('#app'); const headerTitle=$('#headerTitle'); const headerActions=$('#headerActions'); const badgeTotal=$('#badgeTotal');
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.opacity='1'; clearTimeout(t._t); t._t=setTimeout(()=>t.style.opacity='0',1800); }
const norm = s => String(s??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
const slugify = s => norm(s).replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
const caps = s => String(s||'').toUpperCase();

function normalizeFoto(url){
  if(!url) return '';
  // drive view -> uc
  const m = String(url).match(/\/file\/d\/([^/]+)\//);
  return m ? `https://drive.google.com/uc?id=${m[1]}` : url;
}

function buildId(r){
  const cls = r.classificacao || r.empresa || 'SEM CLASSIFICAÃ‡ÃƒO';
  return slugify(cls)+'__'+slugify(r.item||'');
}

function parseReceita(val){
  if(Array.isArray(val)) return val;
  if(typeof val==='string' && val.trim()){
    try{ return JSON.parse(val); }catch{ return []; }
  }
  return [];
}

function mapRow(raw){
  // normaliza chaves
  const obj = {};
  Object.entries(raw||{}).forEach(([k,v])=>{
    const nk = norm(k).replace(/[^a-z0-9]/g,''); // ex.: "FOTO URL" -> "fotourl"
    obj[nk] = v;
  });
  return {
    empresa: obj.empresa || raw.empresa || '',
    classificacao: obj.classificacao || raw.classificacao || '',
    item: obj.item || raw.item || '',
    rendimento: obj.qtdrendimento || obj.rendimento || raw.rendimento || '',
    unidadeRend: obj.umdorendimento || obj.unidaderend || raw.unidadeRend || '',
    receita: parseReceita(obj.receitajson || obj.receita || raw.receita),
    fotoUrl: normalizeFoto(obj.fotourl || raw.fotoUrl || raw.foto || ''),
    custoReceita: Number(String(obj.custodareceita||'').toString().replace(',','.'))||0,
    custoPorGMl: Number(String(obj.custoporgramaml||'').toString().replace(',','.'))||0,
    custoPorKgL: Number(String(obj.custoporkgl||'').toString().replace(',','.'))||0,
    usuario: obj.usuario || raw.usuario || '',
    data: obj.data || raw.data || ''
  };
}

/* ===== DATA ===== */
async function fetchReceitas(){
  try{
    const r = await fetch(WEBAPP_URL+'?action=receitas&ts='+Date.now(),{cache:'no-store'});
    const j = await r.json();
    const rows = Array.isArray(j) ? j : (j && j.ok ? (j.data||[]) : []);
    RECEITAS = rows.map(mapRow).map(r=>{
      const cls = (r.classificacao && r.classificacao.trim()) || r.empresa || 'SEM CLASSIFICAÃ‡ÃƒO';
      return {...r, classificacao: cls, id: buildId({...r, classificacao:cls})};
    });
    INDEX_BY_ID.clear(); RECEITAS.forEach(r=> INDEX_BY_ID.set(r.id,r));
    badgeTotal.textContent = `Receitas: ${RECEITAS.length}`;
  }catch(e){
    badgeTotal.textContent = 'Erro ao carregar';
    app.innerHTML = `<div class="muted">Falha ao buscar receitas.</div>`;
  }
}

/* ===== ROUTER ===== */
function parseHash(){
  const h = location.hash.replace(/^#\//,'').split('/').filter(Boolean);
  if(h.length===0) return { page:'home' };
  if(h[0]==='setor' && h.length===2) return { page:'setor', setor:h[1] };
  if(h[0]==='setor' && h[2]==='item' && h.length===4) return { page:'item', setor:h[1], id:h[3] };
  return { page:'home' };
}
function goHome(){ location.hash = '#/'; }
function goSetor(slug){ location.hash = '#/setor/'+slug; }
function goItem(slug,id){ location.hash = `#/setor/${slug}/item/${id}`; }

/* ===== VIEWS ===== */
function viewHome(){
  headerTitle.textContent='Setores';
  headerActions.style.visibility='visible';
  const grid=document.createElement('div'); grid.className='grid';

  Object.keys(SETORES).forEach(slug=>{
    const clsList = SETORES[slug].map(c=>caps(c));
    const count = RECEITAS.filter(r=>{
      const base = caps((r.classificacao||r.empresa||'SEM CLASSIFICAÃ‡ÃƒO'));
      // compara sem acento
      const baseN = caps(norm(base));
      return clsList.map(x=>caps(norm(x))).includes(baseN);
    }).length;

    const card=document.createElement('div'); card.className='card clickable';
    card.onclick=()=>goSetor(slug);
    card.innerHTML = `
      <div style="font-size:1.05rem;font-weight:700;margin-bottom:6px">${NOME_SETOR[slug]||slug}</div>
      <div class="caps">Inclui: ${SETORES[slug].join(', ')}</div>
      <div style="height:10px"></div>
      <span class="pill">Itens ${count}</span>
    `;
    grid.appendChild(card);
  });

  app.innerHTML=''; app.appendChild(grid);
}

function receitasDoSetor(slug){
  const targets = (SETORES[slug]||[]).map(x=>caps(norm(x)));
  return RECEITAS.filter(r=>{
    const base = caps(norm((r.classificacao||r.empresa||'SEM CLASSIFICAÃ‡ÃƒO')));
    return targets.includes(base);
  });
}

function viewSetor(slug){
  headerTitle.textContent = NOME_SETOR[slug] || slug;
  const list = receitasDoSetor(slug);
  headerActions.innerHTML = `
    <button class="btn" onclick="navigator.clipboard.writeText(location.href);toast('Link copiado!')">ðŸ”— Copiar link</button>
    <button class="btn" onclick="goHome()">â—€ Voltar</button>
    <span class="pill">${list.length} itens</span>
  `;

  const tool = document.createElement('div');
  tool.style.marginBottom='12px';
  tool.innerHTML = `
    <label class="caps" style="display:block;margin-bottom:6px">Buscar</label>
    <input id="inpBusca" placeholder="Nome do produto...">
  `;

  const wrap=document.createElement('div'); wrap.className='list';

  function render(){
    const q = norm($('#inpBusca').value||'');
    wrap.innerHTML='';
    const subset = list.filter(r => !q || norm(r.item).includes(q));
    if(!subset.length){
      wrap.innerHTML = `<div class="muted">Nenhum item para este setor.</div>`;
      return;
    }
    subset.forEach(r=>{
      const card=document.createElement('div'); card.className='item-card';
      const img=document.createElement('img'); img.className='thumb'; img.src=r.fotoUrl||''; img.alt=r.item||'Foto';
      const body=document.createElement('div'); body.className='item-body';
      body.innerHTML = `
        <div class="item-title">${r.item||''}</div>
        <div class="item-sub">${r.classificacao||r.empresa||'SEM CLASSIFICAÃ‡ÃƒO'}</div>
        <div class="item-actions">
          <button class="btn primary">Abrir</button>
        </div>
      `;
      body.querySelector('.btn').onclick = ()=> goItem(slug, r.id);
      card.appendChild(img); card.appendChild(body);
      wrap.appendChild(card);
    });
  }
  app.innerHTML=''; app.appendChild(tool); app.appendChild(wrap);
  $('#inpBusca').addEventListener('input', render);
  render();
}

function viewItem(slug,id){
  const r = INDEX_BY_ID.get(id);
  if(!r){ app.textContent='Receita nÃ£o encontrada.'; return; }
  headerTitle.textContent=r.item||'Receita';
  headerActions.innerHTML = `
    <button class="btn" onclick="navigator.clipboard.writeText(location.href);toast('Link copiado!')">ðŸ”— Copiar link</button>
    <button class="btn" onclick="goSetor('${slug}')">â—€ ${NOME_SETOR[slug]||slug}</button>
  `;

  const detail=document.createElement('div'); detail.className='detail';
  const hero=document.createElement('div'); hero.className='hero';
  hero.innerHTML = `
    <img src="${r.fotoUrl||''}" alt="${r.item||'Foto'}"/>
    <h2>${r.item||''}</h2>
    <div class="meta">
      <span class="pill">ClassificaÃ§Ã£o: <strong>${r.classificacao||r.empresa||'SEM CLASSIFICAÃ‡ÃƒO'}</strong></span>
      ${r.rendimento ? `<span class="pill">Rendimento: <strong>${r.rendimento} ${(r.unidadeRend||'').toUpperCase()}</strong></span>`:''}
    </div>
  `;

  const right=document.createElement('div'); right.className='box';
  right.innerHTML = `
    <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
      <div>
        <label class="caps" style="display:block;margin-bottom:6px">Quantas receitas</label>
        <input id="mult" type="number" min="1" step="1" value="1">
      </div>
      ${r.rendimento?`<span class="pill" id="rendTotal">â€”</span>`:''}
    </div>
    <div style="height:10px"></div>
    <div class="caps" style="margin-bottom:6px">Ingredientes</div>
    <ul class="ing-list" id="ingList"></ul>
  `;

  detail.appendChild(hero); detail.appendChild(right);
  app.innerHTML=''; app.appendChild(detail);

  const ul = right.querySelector('#ingList');
  const multInp = right.querySelector('#mult');
  const rendTotal = right.querySelector('#rendTotal');

  const fmtQty = n => {
    const v=Number(n||0); if (v===Math.trunc(v)) return v.toString();
    return v.toLocaleString('pt-BR',{maximumFractionDigits:4});
  };

  function renderIng(){
    const m = Math.max(1, parseInt(multInp.value||'1',10));
    ul.innerHTML='';
    (r.receita||[]).forEach(i=>{
      const li=document.createElement('li');
      const qtd=Number(i.qtd||i.quantidade||0)*m;
      li.innerHTML = `
        <div class="ing-left">
          <span class="pill">${fmtQty(qtd)} ${(i.um||'').toUpperCase()}</span>
          <strong>${i.item||i.nome||''}</strong>
        </div>
        ${i.codigo?`<span class="muted">(${i.codigo})</span>`:''}
      `;
      ul.appendChild(li);
    });
    if(rendTotal){
      const total = (Number(r.rendimento||0) * m) || 0;
      rendTotal.textContent = total ? `Rendimento total: ${fmtQty(total)} ${(r.unidadeRend||'').toUpperCase()}` : 'â€”';
    }
  }
  multInp.addEventListener('input', renderIng);
  renderIng();
}

/* ===== APP ===== */
function route(){
  const r=parseHash();
  if(r.page==='home') viewHome();
  if(r.page==='setor') viewSetor(r.setor);
  if(r.page==='item') viewItem(r.setor,r.id);
}
window.addEventListener('hashchange', route);

(async function start(){
  app.innerHTML = '<div class="muted">Carregandoâ€¦</div>';
  await fetchReceitas();
  route();
})();
</script>
</body>
</html>
