<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel • Setores e Receitas</title>
<style>
  :root{ --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f7f7f7; --muted:#cfcfcf; --brand:#2563eb; --ghost:#374151; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
  header{position:sticky;top:0;z-index:5;background:#0f0f10;border-bottom:1px solid var(--line)}
  .top{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px;max-width:1100px;margin:0 auto}
  .top h1{font-size:1.2rem;margin:0}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--ghost);background:#111;font-size:.8rem}
  .btn{border:1px solid var(--ghost);background:#121212;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand)}
  .container{max-width:1100px;margin:16px auto;padding:0 16px 24px}
  .grid{display:grid;gap:14px}
  @media (min-width: 840px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media (min-width: 1200px){ .grid{grid-template-columns:repeat(4,1fr)} }
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
  .card.clickable{cursor:pointer;transition:transform .06s ease}
  .card.clickable:hover{transform:translateY(-2px)}
  .muted{color:var(--muted)}
  .list{display:grid;gap:12px}
  @media (min-width: 768px){ .list{grid-template-columns:repeat(2,1fr)} }
  .item-card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px;display:flex;gap:12px;align-items:flex-start}
  .thumb{flex:0 0 120px;height:90px;border-radius:10px;object-fit:cover;border:1px solid var(--line);background:#0d0d0e}
  .item-body{flex:1}
  .item-title{font-weight:700;margin-bottom:4px}
  .item-sub{font-size:.85rem;color:var(--muted)}
  .item-actions{display:flex;gap:8px;margin-top:8px}
  .detail{display:grid;gap:14px}
  @media (min-width: 900px){ .detail{grid-template-columns: 1.1fr 1fr} }
  .hero img{width:100%;max-height:360px;object-fit:cover;border-radius:12px;border:1px solid var(--line);background:#0d0d0e}
</style>
</head>
<body>
<header>
  <div class="top">
    <h1 id="headerTitle">Setores</h1>
    <div class="actions" id="headerActions"><span class="pill" id="badgeTotal">Carregando…</span></div>
  </div>
</header>

<div class="container" id="app"></div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxMAZS538fWhFYEWyPZEEaB4lAEdjEBOinf_UCLNVSOnEbMosuR4UeKIgMw2aVuAI48/exec';

const SETORES = {
  bar: ['DRINKS','CACHAÇAS','COQUETÉIS','BEBIDAS','SUCOS','CAIPIRINHAS'],
  confeitaria: ['CONFEITARIA','DOCES','BOLOS'],
  padaria: ['PADARIA','PÃES','SALGADOS'],
  cozinha: ['COZINHA','PRATOS','ALMOÇO','JANTAR'],
};
const NOME_SETOR = { bar:'Bar', confeitaria:'Confeitaria', padaria:'Padaria', cozinha:'Cozinha' };

let RECEITAS = [], INDEX_BY_ID = new Map();

const $ = s=>document.querySelector(s);
const app = $('#app'); const headerTitle=$('#headerTitle'); const headerActions=$('#headerActions'); const badgeTotal=$('#badgeTotal');

function normalizeFoto(url){
  if(!url) return 'https://via.placeholder.com/120x90?text=Sem+Foto';
  let id='';
  let m=url.match(/\/file\/d\/([^/]+)\//);
  if(m) id=m[1];
  if(!id){ m=url.match(/[?&]id=([^&]+)/); if(m) id=m[1]; }
  if(!id){ m=url.match(/uc\?id=([^&]+)/); if(m) id=m[1]; }
  return id ? `https://drive.google.com/uc?id=${id}` : 'https://via.placeholder.com/120x90?text=Sem+Foto';
}

function mapRow(raw){ return {...raw, fotoUrl: normalizeFoto(raw.fotoUrl||raw['FOTO URL']||''), id:(raw.classificacao||'')+'_'+(raw.item||'')}; }

async function fetchReceitas(){
  try{
    const r=await fetch(WEBAPP_URL+'?action=receitas&ts='+Date.now());
    const j=await r.json();
    const rows=Array.isArray(j)?j:(j&&j.ok?(j.data||[]):[]);
    RECEITAS=rows.map(mapRow);
    INDEX_BY_ID.clear(); RECEITAS.forEach(r=>INDEX_BY_ID.set(r.id,r));
    badgeTotal.textContent=`Receitas: ${RECEITAS.length}`;
  }catch(e){ badgeTotal.textContent='Erro'; }
}

function goHome(){ location.hash='#/'; }
function goSetor(slug){ location.hash='#/setor/'+slug; }
function goItem(slug,id){ location.hash=`#/setor/${slug}/item/${id}`; }

function viewHome(){
  headerTitle.textContent='Setores';
  const grid=document.createElement('div'); grid.className='grid';
  Object.keys(SETORES).forEach(slug=>{
    const count=RECEITAS.filter(r=>SETORES[slug].includes((r.classificacao||'').toUpperCase())).length;
    const card=document.createElement('div'); card.className='card clickable';
    card.onclick=()=>goSetor(slug);
    card.innerHTML=`<div style="font-weight:700">${NOME_SETOR[slug]}</div><div class="pill">Itens ${count}</div>`;
    grid.appendChild(card);
  });
  app.innerHTML=''; app.appendChild(grid);
}

function viewSetor(slug){
  headerTitle.textContent=NOME_SETOR[slug];
  const list=RECEITAS.filter(r=>SETORES[slug].includes((r.classificacao||'').toUpperCase()));
  const wrap=document.createElement('div'); wrap.className='list';
  list.forEach(r=>{
    const card=document.createElement('div'); card.className='item-card';
    const img=document.createElement('img'); img.className='thumb';
    img.src=r.fotoUrl; img.onerror=()=>{img.src='https://via.placeholder.com/120x90?text=Sem+Foto';};
    const body=document.createElement('div'); body.className='item-body';
    body.innerHTML=`<div class="item-title">${r.item}</div><div class="item-sub">${r.classificacao}</div><div class="item-actions"><button class="btn primary">Abrir</button></div>`;
    body.querySelector('.btn').onclick=()=>goItem(slug,r.id);
    card.appendChild(img); card.appendChild(body); wrap.appendChild(card);
  });
  app.innerHTML=''; app.appendChild(wrap);
}

function viewItem(slug,id){
  const r=INDEX_BY_ID.get(id); if(!r){app.textContent='Não encontrada';return;}
  const detail=document.createElement('div'); detail.className='detail';
  detail.innerHTML=`<div class="hero"><img src="${r.fotoUrl}" onerror="this.src='https://via.placeholder.com/600x400?text=Sem+Foto'"/><h2>${r.item}</h2></div>`;
  app.innerHTML=''; app.appendChild(detail);
}

function route(){
  const h=location.hash.replace(/^#\//,'').split('/');
  if(!h[0]) viewHome();
  else if(h[0]==='setor'&&h[1]) viewSetor(h[1]);
  else if(h[0]==='setor'&&h[2]==='item'&&h[3]) viewItem(h[1],h[3]);
}

window.addEventListener('hashchange',route);
(async function start(){await fetchReceitas();route();})();
</script>
</body>
</html>
